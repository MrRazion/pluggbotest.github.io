import React, {useEffect, useState, useRef} from "react";

/*
  GiftChecker - Telegram WebApp
  Single-file React component meant to be used inside a Telegram WebApp (bot / mini app).
  - TailwindCSS classes are used for styling. Make sure Tailwind is present in the build.
  - This component reads window.Telegram.WebApp.initDataUnsafe to get the user (name, username, id, photo_url)
    (photo_url is provided by Telegram Web Apps when user's privacy allows it; otherwise avatar will be placeholder.)
  - For Fragment data (gifts, models, backdrops, symbols) this component calls a placeholder API
    at /api/fragment/* which you should implement server-side (because Fragment's official API requires auth
    and CORS; a server-side proxy is recommended). Example endpoints used below:
      GET /api/fragment/catalog?type=gifts
      GET /api/fragment/catalog?type=models
      GET /api/fragment/catalog?type=backdrops
      GET /api/fragment/catalog?type=symbols
  - The UI follows the user's design requirements: dark/black design, Telegram-like font (replace with a Telegram font import if desired),
    liquid-glass cards, progress loader that verifies real Telegram user data from initDataUnsafe.

  Notes on "real checks":
  - A Telegram WebApp running inside a user's Telegram client receives and signs initialization data (initData).
    We trust initDataUnsafe for quick display, and for security you may validate initData on your server using the bot token
    and the initData hash if you need cryptographic verification.
  - The WebApp cannot magically "poll" Telegram for changes without a reload; we show a simulated progress that reads
    the current initData on load and treats it as the verified source. If you want live monitoring of profile changes,
    you'll need to implement a bot-side check (server) that compares user data over time.
*/

// Simple placeholder fallback avatar
const FALLBACK_AVATAR = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='%23333333'/><text x='50%' y='54%' font-size='120' text-anchor='middle' fill='%23ffffff' font-family='sans-serif'>U</text></svg>";

export default function GiftChecker() {
  const [loading, setLoading] = useState(true);
  const [progress, setProgress] = useState(0);
  const [telegramUser, setTelegramUser] = useState(null);
  const [verifiedUser, setVerifiedUser] = useState(null);
  const [catalog, setCatalog] = useState({gifts: [], models: [], backdrops: [], symbols: []});
  const [activeFilter, setActiveFilter] = useState("gifts");
  const [search, setSearch] = useState("");
  const [selectedGift, setSelectedGift] = useState(null);
  const [selectedModel, setSelectedModel] = useState(null);
  const [selectedBackdrop, setSelectedBackdrop] = useState(null);
  const [selectedSymbol, setSelectedSymbol] = useState(null);
  const progressRef = useRef(null);

  // Utility to read Telegram WebApp user data (initDataUnsafe)
  function readTelegramUser() {
    try {
      if (window.Telegram && window.Telegram.WebApp) {
        const w = window.Telegram.WebApp;
        // initDataUnsafe.user is a JS object with user info if available
        const u = w.initDataUnsafe && w.initDataUnsafe.user ? w.initDataUnsafe.user : null;
        return u;
      }
    } catch (e) {
      console.warn("Telegram WebApp not available", e);
    }
    return null;
  }

  // Background progress + checks
  useEffect(() => {
    const user = readTelegramUser();
    setTelegramUser(user);

    // Simulate progressive checking bar while performing 'real' checks (reading initData and fetching catalog)
    let p = 0;
    setProgress(0);
    setLoading(true);

    progressRef.current = setInterval(() => {
      p += Math.random() * 12;
      if (p >= 98) p = 98; // wait until network calls finish
      setProgress(Math.round(p));
    }, 400);

    // fetch catalog data (server-side proxy recommended)
    async function loadAllCatalogs() {
      try {
        const endpoints = [
          {key: 'gifts', url: '/api/fragment/catalog?type=gifts'},
          {key: 'models', url: '/api/fragment/catalog?type=models'},
          {key: 'backdrops', url: '/api/fragment/catalog?type=backdrops'},
          {key: 'symbols', url: '/api/fragment/catalog?type=symbols'},
        ];
        const results = {};
        await Promise.all(endpoints.map(async (ep) => {
          try {
            const resp = await fetch(ep.url);
            if (!resp.ok) throw new Error('network');
            const json = await resp.json();
            results[ep.key] = Array.isArray(json) ? json : json.items || [];
          } catch (e) {
            console.warn('Could not load', ep.url, e);
            results[ep.key] = [];
          }
        }));

        setCatalog(prev => ({...prev, ...results}));
      } catch (e) {
        console.error('Catalog load failed', e);
      }
    }

    loadAllCatalogs().finally(() => {
      // finish progress
      clearInterval(progressRef.current);
      setProgress(100);
      // small delay for UX
      setTimeout(() => {
        setVerifiedUser(user); // 'real check' result is whatever initDataUnsafe provided
        setLoading(false);
      }, 350);
    });

    return () => clearInterval(progressRef.current);
  }, []);

  // Derived display name
  const displayName = verifiedUser ? `${verifiedUser.first_name || ''} ${verifiedUser.last_name || ''}`.trim() : 'Unknown';
  const username = verifiedUser ? (verifiedUser.username ? `@${verifiedUser.username}` : '(no username)') : '';
  const userId = verifiedUser ? verifiedUser.id : '';
  const avatarUrl = verifiedUser && verifiedUser.photo_url ? verifiedUser.photo_url : FALLBACK_AVATAR;

  // Filtering logic
  function itemsForActiveFilter() {
    const list = catalog[activeFilter] || [];
    if (!search) return list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    return list.filter(i => (i.name||'').toLowerCase().includes(search.toLowerCase())).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  }

  // When selecting gift/model/backdrop/symbol, update preview
  function handleSelect(item, kind) {
    if (kind === 'gifts') setSelectedGift(item);
    if (kind === 'models') setSelectedModel(item);
    if (kind === 'backdrops') setSelectedBackdrop(item);
    if (kind === 'symbols') setSelectedSymbol(item);
  }

  // Simple Price display helper (expects price object or number)
  function priceText(item) {
    if (!item) return '';
    if (typeof item.price === 'number') return `${item.price} TON`;
    if (item.price && item.price.amount) return `${item.price.amount} TON`;
    if (item.floor_price) return `${item.floor_price} TON`;
    return item.price_text || '';
  }

  // Preview computed composite: combine selected model/backdrop/symbol into a display
  function renderPreviewOverlays() {
    const overlays = [];
    if (selectedBackdrop) overlays.push(<div key="backdrop" className="absolute inset-0 rounded-2xl mix-blend-multiply opacity-60" style={{background: selectedBackdrop.color || 'transparent'}} />);
    if (selectedModel) overlays.push(<div key="model" className="absolute left-4 top-4 p-2 rounded-full border border-white/8 backdrop-blur-sm"> <div className="text-xs">{selectedModel.name}</div></div>);
    if (selectedSymbol) overlays.push(<div key="symbol" className="absolute right-3 bottom-3 p-1 rounded-md bg-white/6"> <div className="text-sm">{selectedSymbol.name}</div></div>);
    return overlays;
  }

  return (
    <div className="min-h-screen bg-black text-white font-sans p-6" style={{fontFamily: 'Inter, system-ui, -apple-system, "Segoe UI", Roboto'}}>
      {/* Header */}
      <div className="max-w-5xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-2xl font-semibold tracking-tight">GiftChecker</h1>
          <div className="flex gap-2 items-center">
            <div className="text-sm text-white/70">{username}</div>
            <div className="text-sm text-white/40">ID: {userId}</div>
          </div>
        </div>

        {/* Loading overlay */}
        {loading && (
          <div className="fixed inset-0 z-50 flex items-center justify-center pointer-events-none">
            <div className="w-full max-w-md p-8 bg-black/60 backdrop-blur-lg rounded-2xl border border-white/6 text-center pointer-events-auto">
              <div className="text-3xl font-bold mb-6">FonChecker</div>
              <div className="h-40 flex items-center justify-center">
                <div className="w-32 h-32 rounded-xl bg-white/6 flex items-center justify-center">
                  <img src={avatarUrl} alt="avatar" className="w-24 h-24 rounded-full object-cover" />
                </div>
              </div>
              <div className="mt-6">
                <div className="w-full bg-white/6 rounded-lg h-4 overflow-hidden">
                  <div className="h-full rounded-lg bg-white" style={{width: `${progress}%`, transition: 'width 300ms linear'}}></div>
                </div>
                <div className="mt-2 text-sm text-white/60">Checking Telegram name, avatar, username...</div>
              </div>
            </div>
          </div>
        )}

        {/* Main card preview */}
        <div className="mx-auto my-6 max-w-3xl">
          <div className="relative bg-gray-900/70 border border-white/6 rounded-3xl p-8 pt-16 min-h-[220px] flex items-start justify-center">
            {/* Avatar slightly overlapping */}
            <div className="absolute -top-12 left-6">
              <div className="w-28 h-28 rounded-xl overflow-hidden border-2 border-white/10 shadow-lg bg-gradient-to-br from-white/6 to-white/3">
                <img src={avatarUrl} alt="avatar" className="w-full h-full object-cover" />
              </div>
            </div>

            {/* User info */}
            <div className="text-left ml-36 w-full">
              <div className="text-xl font-semibold">{displayName}</div>
              <div className="flex items-center gap-3 mt-2">
                <div className="text-sm text-white/60">{username}</div>
                <div className="ml-auto text-sm text-white/40">ID: {userId}</div>
              </div>

              {/* Description / longish translucent rectangle */}
              <div className="mt-6">
                <div className="rounded-xl bg-white/4 p-4 text-sm text-white/60 backdrop-blur-sm min-h-[72px]">{verifiedUser && verifiedUser.bio ? verifiedUser.bio : 'No public description available.'}</div>
              </div>

              {/* Overlays for selected items (model/backdrop/symbol) */}
              <div className="relative mt-4 h-40 rounded-xl overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-b from-transparent to-black/60" />
                {renderPreviewOverlays()}
              </div>
            </div>
          </div>
        </div>

        {/* Filters */}
        <div className="flex gap-3 items-center mb-4">
          {['gifts','models','backdrops','symbols'].map(f => (
            <button key={f} onClick={()=>{setActiveFilter(f); setSearch('');}} className={`px-3 py-1 rounded-md text-sm font-medium ${activeFilter===f? 'bg-white text-black':'bg-white/6 text-white/80'}`}>
              {f[0].toUpperCase()+f.slice(1)} <span className="ml-1 text-xs text-white/50">▾</span>
            </button>
          ))}

          <div className="ml-auto max-w-xs w-full">
            <input value={search} onChange={e=>setSearch(e.target.value)} placeholder={`Find a ${activeFilter.slice(0,-1)}`} className="w-full px-3 py-2 rounded-lg bg-white/5 outline-none placeholder-white/40 text-sm" />
          </div>
        </div>

        {/* List header */}
        <div className="bg-white/3 rounded-xl p-3">
          <div className="grid grid-cols-[auto_1fr_auto] gap-4 items-center">
            <div className="text-sm text-white/80">Select</div>
            <div className="text-sm text-white/80">Name</div>
            <div className="text-sm text-white/80">Price</div>
          </div>
        </div>

        {/* Items list */}
        <div className="mt-3 space-y-2">
          {itemsForActiveFilter().map(item => (
            <div key={item.id || item.slug || item.name} className="bg-black/60 rounded-xl p-3 border border-white/4 flex items-center gap-3">
              <div className="w-8">
                <button onClick={()=>handleSelect(item, activeFilter)} className="w-6 h-6 rounded-md bg-white/6 flex items-center justify-center">
                  {((activeFilter==='models' && selectedModel===item) || (activeFilter==='gifts' && selectedGift===item) || (activeFilter==='backdrops' && selectedBackdrop===item) || (activeFilter==='symbols' && selectedSymbol===item)) ? '✓' : '+'}
                </button>
              </div>
              <div className="flex items-center gap-3 flex-1">
                {/* icon: gift icon or color dot */}
                {activeFilter==='gifts' && (
                  <div className="w-12 h-12 rounded-md bg-white/4 flex items-center justify-center">🎁</div>
                )}
                {activeFilter==='models' && (
                  <div className="w-10 h-10 rounded-full flex items-center justify-center" style={{background: item.color || '#444'}} />
                )}
                {activeFilter==='backdrops' && (
                  <div className="w-12 h-12 rounded-md border border-white/6" style={{background: item.color || '#222'}} />
                )}
                {activeFilter==='symbols' && (
                  <div className="w-12 h-12 rounded-md bg-white/4 flex items-center justify-center">★</div>
                )}

                <div>
                  <div className="font-medium">{item.name}</div>
                  <div className="text-xs text-white/50">{item.subtitle || ''}</div>
                </div>
              </div>
              <div className="text-sm text-white/60">{priceText(item)}</div>
            </div>
          ))}

          {itemsForActiveFilter().length===0 && (
            <div className="text-center text-white/50 py-8">No items found. Make sure your fragment proxy (/api/fragment/...) is implemented and returning data.</div>
          )}
        </div>

        {/* Footer / apply */}
        <div className="mt-6 flex items-center justify-between">
          <div className="text-sm text-white/50">Preview changes live on the card above. Choose gift, model, backdrop and symbol.</div>
          <div className="flex gap-3">
            <button className="px-4 py-2 rounded-xl bg-white/6">Reset</button>
            <button className="px-4 py-2 rounded-xl bg-white text-black font-semibold">Apply</button>
          </div>
        </div>

        {/* Tiny help & notes */}
        <div className="mt-6 text-xs text-white/40 max-w-2xl">Notes: This WebApp uses the Telegram WebApp initData to read the user's name, username, id and (when available) photo_url. For complete and secure verification validate initData on your server. For the Fragment catalog we expect a server-side proxy to call Fragment GraphQL / API (see https://fragment.dev/api-reference). This keeps your API credentials safe and avoids CORS issues.</div>
      </div>
    </div>
  );
}
