<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLUGG BOT</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js"></script>
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --tg-safe-area-inset-top: 0px;
            --tg-safe-area-inset-bottom: 0px;
            --tg-safe-area-inset-left: 0px;
            --tg-safe-area-inset-right: 0px;
            --primary-gradient: linear-gradient(45deg, #121212, #1e1e1e);
            --accent-green: #34c759;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.4);
            --border-radius-lg: 16px;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
            --text-gradient: linear-gradient(45deg, #ffffff, #d0d0d0);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            transition: all 0.3s ease; /* Добавляем плавность ко всем элементам */
        }
        
        body {
            background: #000000; /* Черный фон */
            color: var(--tg-theme-text-color, #ffffff);
            line-height: 1.6;
            padding-top: var(--tg-safe-area-inset-top);
            padding-bottom: calc(100px + var(--tg-safe-area-inset-bottom));
            padding-left: var(--tg-safe-area-inset-left);
            padding-right: var(--tg-safe-area-inset-right);
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-soft);
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
            color: var(--tg-theme-text-color, #ffffff);
            background: var(--text-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: var(--tg-theme-hint-color, #aaaaaa);
            font-size: 14px;
        }
        
        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            animation: pulse 1.5s infinite;
        }
        
        .profile-icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tabs {
            display: flex;
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 5px;
            scrollbar-width: none;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-md);
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            padding: 10px 20px;
            background: #1c1c1c;
            border-radius: var(--border-radius-md);
            margin: 5px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            animation: slideIn 0.5s ease;
        }
        
        .tab.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-soft);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .game-card {
            background: #1a1a1a;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: var(--shadow-soft);
            animation: cardAppear 0.5s ease;
        }
        
        @keyframes cardAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .game-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }
        
        .game-card:active {
            transform: scale(0.98);
        }
        
        .game-image {
            width: 100%;
            height: 120px;
            overflow: hidden;
            position: relative;
        }
        
        .game-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        
        .game-card:hover .game-image img {
            transform: scale(1.1);
        }
        
        .game-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            height: 50%;
        }
        
        .game-info {
            padding: 12px;
        }
        
        .game-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--tg-theme-text-color, #ffffff);
        }
        
        .game-description {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #aaaaaa);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .game-details {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            padding-top: var(--tg-safe-area-inset-top);
            padding-bottom: var(--tg-safe-area-inset-bottom);
            padding-left: var(--tg-safe-area-inset-left);
            padding-right: var(--tg-safe-area-inset-right);
            animation: fadeIn 0.3s ease;
        }
        
        .game-details.active {
            display: block;
        }
        
        .game-details-content {
            background: #1c1c1c;
            border-radius: var(--border-radius-lg);
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow-soft);
        }
        
        .game-details-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .game-details-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            margin-right: 15px;
            flex-shrink: 0;
            box-shadow: var(--shadow-soft);
        }
        
        .game-details-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .game-details-info {
            flex: 1;
        }
        
        .game-details-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
            background: var(--text-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .game-details-meta {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #aaaaaa);
            margin-bottom: 20px;
        }
        
        .download-btn-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .download-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            padding: 16px;
            background: var(--primary-gradient);
            color: #ffffff;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            box-shadow: var(--shadow-soft);
        }
        
        .download-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .download-btn:not(:disabled):hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #ffffff);
            display: flex;
            align-items: center;
        }
        
        .section-content {
            background: #0f0f0f;
            border-radius: var(--border-radius-md);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .section-content p {
            margin-bottom: 10px;
        }
        
        .section-content ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        
        .section-content li {
            margin-bottom: 5px;
        }
        
        .new-indicator {
            width: 10px;
            height: 10px;
            background-color: var(--accent-green);
            border-radius: 50%;
            margin-left: 10px;
            animation: flash 1.5s infinite;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
            background: #1c1c1c;
            border-radius: var(--border-radius-md);
            padding: 10px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .progress-text {
            font-size: 14px;
            color: #aaaaaa;
        }
        
        .progress-percent {
            font-weight: bold;
            color: #40a7e3;
        }
        
        .progress-bar {
            height: 8px;
            background: #333;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-sm);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .download-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            background: #333;
            border-radius: var(--border-radius-md);
            padding: 8px;
            font-family: monospace;
            font-size: 12px;
            color: #ccc;
        }
        
        .download-graph-toggle {
            width: 24px;
            height: 24px;
            background: #444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .download-graph-toggle::before {
            content: '↓';
            color: #fff;
        }
        
        .download-graph {
            display: none;
            height: 50px;
            margin-top: 10px;
            background: #222;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
        }
        
        .download-graph.active {
            display: block;
        }
        
        .graph-bar {
            height: 100%;
            width: 5px;
            background: var(--primary-gradient);
            margin-right: 2px;
            display: inline-block;
            animation: barAnimate 1s infinite alternate;
        }
        
        @keyframes barAnimate {
            0% { transform: scaleY(0.5); }
            100% { transform: scaleY(1); }
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 15px;
            background: #1c1c1c;
            color: #ffffff;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 15px;
            margin-top: 40px;
            box-shadow: var(--shadow-soft);
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 15px;
            border-radius: var(--border-radius-md);
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        .status-success {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
            display: block;
        }
        
        .status-error {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            display: block;
        }
        
        .footer {
            background: var(--primary-gradient);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            margin-top: 30px;
            box-shadow: var(--shadow-soft);
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .footer-section {
            flex: 1;
            padding: 0 10px;
        }
        
        .footer-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #ffffff;
        }
        
        .footer-section p, .footer-section a {
            font-size: 12px;
            color: #aaaaaa;
            margin-bottom: 5px;
            text-decoration: none;
        }
        
        .footer-section a {
            color: #6a9eff;
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid #333333;
        }
        
        .footer-bottom p {
            font-size: 12px;
            color: #aaaaaa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-bar {
            margin-bottom: 15px;
            position: relative;
        }
        
        .search-bar input {
            width: 100%;
            padding: 12px 15px;
            padding-left: 40px;
            background: #1c1c1c;
            border: none;
            border-radius: var(--border-radius-md);
            color: #ffffff;
            font-size: 14px;
        }
        
        .search-bar svg {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            fill: #aaaaaa;
        }
        
        /* Модал для входа */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .auth-modal.active {
            display: flex;
        }
        
        .auth-content {
            background: #1c1c1c;
            padding: 20px;
            border-radius: var(--border-radius-lg);
            text-align: center;
            width: 80%;
            max-width: 300px;
            box-shadow: var(--shadow-soft);
        }
        
        .auth-btn {
            margin: 10px 0;
            padding: 12px;
            background: var(--primary-gradient);
            color: #fff;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            width: 100%;
        }
        
        /* Профиль модал */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .profile-modal.active {
            display: block;
        }
        
        .profile-content {
            background: #1c1c1c;
            border-radius: var(--border-radius-lg);
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow-soft);
        }
        
        .profile-banner {
            height: 100px;
            background: #333;
            border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
            position: relative;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #444;
            position: absolute;
            bottom: -40px;
            left: 20px;
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-info {
            margin-top: 50px;
        }
        
        .profile-username {
            font-size: 18px;
            font-weight: 600;
        }
        
        .profile-description {
            color: #aaa;
            margin: 10px 0;
        }
        
        .profile-library {
            margin-top: 20px;
        }
        
        .profile-library h3 {
            font-size: 16px;
        }
        
        .profile-library ul {
            list-style: none;
        }
        
        .profile-library li {
            padding: 8px;
            background: #222;
            margin-bottom: 5px;
            border-radius: var(--border-radius-sm);
        }
        
        .logout-btn {
            margin-top: 20px;
            padding: 12px;
            background: #ff3b30;
            color: #fff;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            width: 100%;
        }
        
        /* Регистрация лоадер */
        .register-loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .register-loader.active {
            display: block;
        }
        
        .register-loader .loader {
            margin: 0 auto 10px;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
            }
            
            .games-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .game-image {
                height: 150px;
            }
            
            .game-details-icon {
                width: 80px;
                height: 80px;
            }
            
            .game-details-title {
                font-size: 24px;
            }
        }
        
        .tg-safe-area {
            padding-top: var(--tg-safe-area-inset-top);
            padding-bottom: var(--tg-safe-area-inset-bottom);
            padding-left: var(--tg-safe-area-inset-left);
            padding-right: var(--tg-safe-area-inset-right);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PLUGG BOT</h1>
            <p>Лучшая коллекция приваток для удобного скачивания</p>
            <div class="profile-icon" id="profile-icon">
                <img src="https://via.placeholder.com/40?text=👤" alt="Profile">
            </div>
        </div>
        
        <div class="search-bar">
            <svg viewBox="0 0 24 24">
                <path d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14Z"/>
            </svg>
            <input type="text" placeholder="Поиск игр..." id="search-input">
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="all">ПРИВАТКИ</div>
            <div class="tab" data-tab="popular">ПРИВАТКИ ДЛЯ ПК</div>
        </div>
        
        <div class="tab-content active" id="all-tab">
            <div class="games-grid"></div>
        </div>
        <div class="tab-content" id="popular-tab">
            <div class="games-grid"></div>
        </div>
        
        <!-- Детали игры -->
        <div class="game-details" id="game-details">
            <button class="back-btn" id="back-btn">← Назад</button>
            
            <div class="game-details-content">
                <div class="game-details-header">
                    <div class="game-details-icon">
                        <img id="details-image" src="" alt="">
                    </div>
                    <div class="game-details-info">
                        <div class="game-details-title" id="details-title"></div>
                        <div class="game-details-meta" id="details-meta"></div>
                    </div>
                </div>
                
                <div class="download-btn-container">
                    <button id="download-btn" class="download-btn">Скачать</button>
                    <button id="add-to-library" class="download-btn" style="background: #4caf50; margin-top: 10px;">Добавить в библиотеку</button>
                </div>
                
                <div class="progress-container" id="progress-container">
                    <div class="progress-info">
                        <span class="progress-text">Статус: <span id="status-text">Готов к загрузке</span></span>
                        <span class="progress-percent" id="progress-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="download-stats" id="download-stats">
                        <span id="download-size">0 MB / 0 MB</span> | <span id="download-speed">0 KB/s</span> | <span id="download-ping">0 ms</span>
                        <div class="download-graph-toggle" id="graph-toggle"></div>
                    </div>
                    <div class="download-graph" id="download-graph">
                        <!-- Bars will be added via JS -->
                    </div>
                </div>
                
                <div id="status-message" class="status-message"></div>
                
                <div class="section-title">Описание</div>
                <div class="section-content" id="details-description"></div>
                
                <div class="section-title">Что нового<span class="new-indicator"></span></div>
                <div class="section-content" id="details-whats-new"></div>
            </div>
        </div>
        
        <div class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>О нас</h3>
                    <p>PLUGG BOT - лучший бот для поиска и скачивания приваток. Мы предлагаем огромную коллекцию популярных приваток.</p>
                </div>
                
                <div class="footer-section">
                    <h3>Наши контакты</h3>
                    <p>Владелец бота: <a href="https://t.me/kurune" target="_blank">Плагги</a></p>
                    <p>По разным вопросам: <a href="https://t.me/soukita" target="_blank">Кита</a></p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>© 2025 Pluggs. Все права защищены.</p>
            </div>
        </div>
    </div>

    <!-- Модал входа -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-content">
            <h2>Вход</h2>
            <button class="auth-btn" id="google-login">Войти через Google</button>
            <button class="auth-btn" id="telegram-login">Войти через Telegram</button>
        </div>
    </div>

    <!-- Лоадер регистрации -->
    <div class="register-loader" id="register-loader">
        <div class="loader"></div>
        <p>Подождите, регистрируем ваш аккаунт...</p>
    </div>

    <!-- Профиль модал -->
    <div class="profile-modal" id="profile-modal">
        <button class="back-btn" id="profile-back-btn">← Назад</button>
        <div class="profile-content">
            <div class="profile-banner" id="profile-banner"></div>
            <div class="profile-avatar">
                <img id="profile-avatar-img" src="https://via.placeholder.com/80?text=👤" alt="Avatar">
            </div>
            <div class="profile-info">
                <div class="profile-username" id="profile-username">@username</div>
                <div class="profile-description" id="profile-description">Описание профиля</div>
                <!-- Кастомизация -->
                <input type="file" id="banner-upload" accept="image/*" style="display: none;">
                <button class="auth-btn" onclick="document.getElementById('banner-upload').click()">Изменить баннер</button>
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                <button class="auth-btn" onclick="document.getElementById('avatar-upload').click()">Изменить аватар</button>
                <input type="text" id="name-input" placeholder="Имя">
                <input type="text" id="username-input" placeholder="Новый username">
                <textarea id="desc-input" placeholder="Описание"></textarea>
                <button class="auth-btn" id="save-profile">Сохранить</button>
                <p id="username-change-note">Смена username доступна через 7 дней после последней смены.</p>
            </div>
            <div class="profile-library">
                <h3>Библиотека</h3>
                <ul id="library-list"></ul>
            </div>
            <button class="logout-btn" id="logout-btn">Выйти из аккаунта</button>
        </div>
    </div>

    <script>
        // Firebase Config (Замените на ваши данные из Firebase Console)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const tg = window.Telegram.WebApp;
        tg.expand();

        // Элементы
        const profileIcon = document.getElementById('profile-icon');
        const authModal = document.getElementById('auth-modal');
        const googleLogin = document.getElementById('google-login');
        const telegramLogin = document.getElementById('telegram-login');
        const registerLoader = document.getElementById('register-loader');
        const profileModal = document.getElementById('profile-modal');
        const profileBackBtn = document.getElementById('profile-back-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileUsername = document.getElementById('profile-username');
        const profileDescription = document.getElementById('profile-description');
        const profileAvatarImg = document.getElementById('profile-avatar-img');
        const profileBanner = document.getElementById('profile-banner');
        const bannerUpload = document.getElementById('banner-upload');
        const avatarUpload = document.getElementById('avatar-upload');
        const nameInput = document.getElementById('name-input');
        const usernameInput = document.getElementById('username-input');
        const descInput = document.getElementById('desc-input');
        const saveProfile = document.getElementById('save-profile');
        const usernameChangeNote = document.getElementById('username-change-note');
        const libraryList = document.getElementById('library-list');
        const addToLibraryBtn = document.getElementById('add-to-library');
        const downloadBtn = document.getElementById('download-btn');
        const progressContainer = document.getElementById('progress-container');
        const downloadSize = document.getElementById('download-size');
        const downloadSpeed = document.getElementById('download-speed');
        const downloadPing = document.getElementById('download-ping');
        const graphToggle = document.getElementById('graph-toggle');
        const downloadGraph = document.getElementById('download-graph');
        const backBtn = document.getElementById('back-btn');
        const gameDetails = document.getElementById('game-details');
        const detailsTitle = document.getElementById('details-title');
        const searchInput = document.getElementById('search-input');

        let currentUser = null;
        let viewingUsername = null;
        let isOwnProfile = true;
        let currentGameId = null;
        let isDownloading = false;
        let xhr = null;
        let currentDownloadUrl = '';
        let currentFileName = '';
        let currentGameTitle = '';
        let startTime = 0;
        let prevLoaded = 0;
        let graphInterval = null;

        // Данные игр
        const games = [
            // ... (same as original, omitted for brevity)
        ];

        // Функция генерации рандом username
        function generateRandomUsername() {
            const animals = ['Liver', 'Owl', 'Struggle', 'Donut', 'Cat', 'Dog', 'Fox', 'Bear', 'Lion', 'Tiger'];
            const adjectives = ['Happy', 'Sad', 'Brave', 'Clever', 'Quick', 'Slow', 'Big', 'Small', 'Red', 'Blue'];
            const number = Math.floor(Math.random() * 90) + 10;
            const animal = animals[Math.floor(Math.random() * animals.length)];
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            return `${adjective}${animal}${number}`;
        }

        // Проверка URL на startapp
        const urlParams = new URLSearchParams(window.location.search);
        const startappParam = urlParams.get('startapp');
        if (startappParam) {
            loadProfile(startappParam, false);
        }

        // Авто-логин если есть
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                loadProfile(user.uid, true);
                profileIcon.querySelector('img').src = user.photoURL || 'https://via.placeholder.com/40?text=👤';
            } else {
                // Показать модал входа если не залогинен и не просмотр профиля
                if (!startappParam) {
                    authModal.classList.add('active');
                }
            }
        });

        // Вход через Google
        googleLogin.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(result => {
                registerUser(result.user);
            }).catch(error => {
                console.error(error);
            });
        });

        // Вход через Telegram
        telegramLogin.addEventListener('click', () => {
            if (tg.initDataUnsafe.user) {
                const tgUser = tg.initDataUnsafe.user;
                auth.signInAnonymously().then(cred => {
                    const user = cred.user;
                    user.updateProfile({
                        displayName: tgUser.username || tgUser.first_name,
                        photoURL: tgUser.photo_url
                    });
                    registerUser(user, true, tgUser.id);
                });
            } else {
                alert('Telegram data not available');
            }
        });

        // Регистрация пользователя
        function registerUser(user, isTelegram = false, tgId = null) {
            authModal.classList.remove('active');
            registerLoader.classList.add('active');
            const usersRef = db.collection('users');
            usersRef.doc(user.uid).get().then(doc => {
                if (!doc.exists) {
                    let username = generateRandomUsername();
                    // Проверка уникальности
                    checkUsernameUnique(username, usersRef, (uniqueUsername) => {
                        const data = {
                            uid: user.uid,
                            name: user.displayName || 'User',
                            username: uniqueUsername,
                            description: '',
                            avatar: user.photoURL || '',
                            banner: '',
                            library: [],
                            lastUsernameChange: firebase.firestore.Timestamp.now(),
                            tgId: isTelegram ? tgId : null
                        };
                        usersRef.doc(user.uid).set(data).then(() => {
                            registerLoader.classList.remove('active');
                            loadProfile(user.uid, true);
                        });
                    });
                } else {
                    registerLoader.classList.remove('active');
                    loadProfile(user.uid, true);
                }
            });
        }

        // Рекурсивная проверка уникальности username
        function checkUsernameUnique(username, usersRef, callback) {
            usersRef.where('username', '==', username).get().then(snapshot => {
                if (snapshot.empty) {
                    callback(username);
                } else {
                    checkUsernameUnique(generateRandomUsername(), usersRef, callback);
                }
            });
        }

        // Загрузка профиля
        function loadProfile(uidOrUsername, isOwn = true) {
            const usersRef = db.collection('users');
            let query;
            if (isOwn) {
                query = usersRef.doc(uidOrUsername);
            } else {
                query = usersRef.where('username', '==', uidOrUsername).limit(1);
            }
            query.get().then(docSnap => {
                let doc;
                if (isOwn) {
                    doc = docSnap;
                } else {
                    doc = docSnap.docs[0];
                }
                if (doc && doc.exists) {
                    const data = doc.data();
                    profileUsername.textContent = `@${data.username}`;
                    profileDescription.textContent = data.description || 'Нет описания';
                    profileAvatarImg.src = data.avatar || 'https://via.placeholder.com/80?text=👤';
                    profileBanner.style.backgroundImage = `url(${data.banner})`;
                    libraryList.innerHTML = data.library.map(gameId => {
                        const game = games.find(g => g.id === gameId);
                        return `<li>${game ? game.title : 'Unknown'}</li>`;
                    }).join('');
                    isOwnProfile = isOwn;
                    if (isOwn) {
                        nameInput.value = data.name;
                        usernameInput.value = data.username;
                        descInput.value = data.description;
                        // Проверка на смену username
                        const now = new Date();
                        const lastChange = data.lastUsernameChange.toDate();
                        const daysSince = (now - lastChange) / (1000 * 60 * 60 * 24);
                        if (daysSince < 7) {
                            usernameInput.disabled = true;
                            usernameChangeNote.textContent = `Смена доступна через ${Math.ceil(7 - daysSince)} дней.`;
                        } else {
                            usernameInput.disabled = false;
                            usernameChangeNote.textContent = '';
                        }
                    } else {
                        // Скрыть редактирование для чужого профиля
                        nameInput.style.display = 'none';
                        usernameInput.style.display = 'none';
                        descInput.style.display = 'none';
                        saveProfile.style.display = 'none';
                        usernameChangeNote.style.display = 'none';
                        document.getElementById('banner-upload').parentNode.style.display = 'none';
                        document.getElementById('avatar-upload').parentNode.style.display = 'none';
                    }
                    profileModal.classList.add('active');
                } else {
                    alert('Профиль не найден');
                }
            });
        }

        // Сохранение профиля
        saveProfile.addEventListener('click', () => {
            if (!currentUser) return;
            const newUsername = usernameInput.value;
            if (newUsername !== currentUser.username) {
                // Проверка уникальности
                db.collection('users').where('username', '==', newUsername).get().then(snapshot => {
                    if (!snapshot.empty) {
                        alert('Этот username уже занят');
                        return;
                    }
                    updateProfile(newUsername);
                });
            } else {
                updateProfile();
            }
        });

        function updateProfile(newUsername = null) {
            const updates = {
                name: nameInput.value,
                description: descInput.value
            };
            if (newUsername) {
                updates.username = newUsername;
                updates.lastUsernameChange = firebase.firestore.Timestamp.now();
            }
            db.collection('users').doc(currentUser.uid).update(updates).then(() => {
                loadProfile(currentUser.uid, true);
            });
        }

        // Загрузка аватара
        avatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const ref = storage.ref(`avatars/${currentUser.uid}`);
                ref.put(file).then(() => {
                    ref.getDownloadURL().then(url => {
                        db.collection('users').doc(currentUser.uid).update({avatar: url});
                        profileAvatarImg.src = url;
                    });
                });
            }
        });

        // Загрузка баннера
        bannerUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const ref = storage.ref(`banners/${currentUser.uid}`);
                ref.put(file).then(() => {
                    ref.getDownloadURL().then(url => {
                        db.collection('users').doc(currentUser.uid).update({banner: url});
                        profileBanner.style.backgroundImage = `url(${url})`;
                    });
                });
            }
        });

        // Добавление в библиотеку
        addToLibraryBtn.addEventListener('click', () => {
            if (!currentUser || !currentGameId) return;
            db.collection('users').doc(currentUser.uid).update({
                library: firebase.firestore.FieldValue.arrayUnion(currentGameId)
            }).then(() => {
                alert('Добавлено в библиотеку');
            });
        });

        // Выход
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                profileModal.classList.remove('active');
                authModal.classList.add('active');
            });
        });

        // Открытие профиля
        profileIcon.addEventListener('click', () => {
            if (currentUser) {
                loadProfile(currentUser.uid, true);
            } else {
                authModal.classList.add('active');
            }
        });

        profileBackBtn.addEventListener('click', () => {
            profileModal.classList.remove('active');
        });

        // Рендеринг игр (same as original)
        function renderGames(tab) {
            // ... (same as original)
        }

        // ... (other functions from original code)

        // Улучшенный download
        function downloadFile() {
            if (isDownloading) return;
            
            isDownloading = true;
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<span class="loader"></span> Загрузка...';
            progressContainer.style.display = 'block';
            updateProgress(0);
            startTime = Date.now();
            prevLoaded = 0;
            startGraph();

            // Симуляция пинга (random for demo)
            downloadPing.textContent = Math.floor(Math.random() * 50 + 10) + ' ms';

            xhr = new XMLHttpRequest();
            xhr.open('GET', currentDownloadUrl, true);
            xhr.responseType = 'blob';
            
            xhr.onprogress = function(event) {
                if (event.lengthComputable) {
                    const loaded = event.loaded;
                    const total = event.total;
                    const percent = Math.round((loaded / total) * 100);
                    updateProgress(percent);
                    const timeElapsed = (Date.now() - startTime) / 1000;
                    const speed = (loaded - prevLoaded) / timeElapsed / 1024; // KB/s
                    downloadSpeed.textContent = speed.toFixed(2) + ' KB/s';
                    downloadSize.textContent = `${(loaded / 1024 / 1024).toFixed(2)} MB / ${(total / 1024 / 1024).toFixed(2)} MB`;
                    prevLoaded = loaded;
                    startTime = Date.now();
                }
            };
            
            // ... (rest of download logic as in original, with reset at end)
            
            xhr.onload = function() {
                // ...
                stopGraph();
            };
        }

        // График
        function startGraph() {
            downloadGraph.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'graph-bar';
                bar.style.animationDelay = `${i * 0.05}s`;
                downloadGraph.appendChild(bar);
            }
            graphInterval = setInterval(updateGraph, 500);
        }

        function updateGraph() {
            // Симуляция
            const bars = downloadGraph.querySelectorAll('.graph-bar');
            bars.forEach(bar => {
                bar.style.height = `${Math.random() * 100}%`;
            });
        }

        function stopGraph() {
            clearInterval(graphInterval);
        }

        graphToggle.addEventListener('click', () => {
            downloadGraph.classList.toggle('active');
        });

        // Инициализация
        tg.ready();
        renderGames('all');
        // ... (other init)
    </script>
</body>
</html>
